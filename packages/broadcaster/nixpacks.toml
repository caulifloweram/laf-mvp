[phases.setup]
nixPkgs = ["nodejs_20", "pnpm"]

[phases.install]
cmds = [
  "cd /app && pnpm install --frozen-lockfile",
  "echo 'Install complete'",
  "echo 'Verifying ws module...'",
  "cd /app/packages/broadcaster && ls -la node_modules/ws 2>/dev/null || echo 'WARNING: ws not found in broadcaster node_modules'",
  "cd /app && ls -la node_modules/ws 2>/dev/null || echo 'WARNING: ws not found in root node_modules'"
]

[phases.build]
cmds = [
  "echo 'Starting build...'",
  "cd /app && pwd && ls -la",
  "echo 'Building broadcaster package...'",
  "cd /app/packages/broadcaster && pnpm build",
  "echo 'Verifying build output...'",
  "ls -la /app/packages/broadcaster/dist/ || echo 'ERROR: dist folder still not found'",
  "test -f /app/packages/broadcaster/dist/index.js && echo '✅ Build successful!' || (echo '❌ Build failed!' && exit 1)",
  "echo 'Verifying dependencies are installed...'",
  "cd /app/packages/broadcaster && test -d node_modules/ws && echo '✅ ws module found' || (echo '❌ ws module missing, installing...' && pnpm install ws)"
]

[start]
cmd = "cd /app/packages/broadcaster && if [ ! -d node_modules/ws ] && [ ! -d ../../node_modules/ws ]; then echo 'Installing missing dependencies...' && pnpm install --no-frozen-lockfile; fi && NODE_PATH=/app/packages/broadcaster/node_modules:/app/node_modules node dist/index.js"
