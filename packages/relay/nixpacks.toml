# Supports both Root Directory = repo root (empty) and Root Directory = packages/relay.

[phases.setup]
nixPkgs = ["nodejs_20", "pnpm"]

[phases.install]
cmds = [
  "cd /app && if [ -d packages/relay ]; then pnpm install --frozen-lockfile; else pnpm install || true; fi",
  "cd /app && if [ ! -d packages/relay ] && [ ! -d node_modules/ws ]; then echo 'Installing ws (relay isolated build)...' && npm install ws; fi",
  "echo 'Install complete'"
]

[phases.build]
cmds = [
  "cd /app && if [ -d packages/relay ]; then cd packages/relay && pnpm build; else pnpm build; fi",
  "test -f /app/packages/relay/dist/index.js 2>/dev/null || test -f /app/dist/index.js || (echo 'Build failed' && exit 1)",
  "echo 'Build complete'"
]

[start]
cmd = "if [ -f /app/packages/relay/dist/index.js ]; then cd /app/packages/relay && NODE_PATH=/app/packages/relay/node_modules:/app/node_modules node dist/index.js; else cd /app && NODE_PATH=/app/node_modules node dist/index.js; fi"
