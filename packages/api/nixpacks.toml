[phases.setup]
nixPkgs = ["nodejs_20", "pnpm"]
cmds = [
  "apt-get update && apt-get install -y build-essential python3 || true"
]

[phases.install]
cmds = [
  "cd /app && pnpm install",
  "echo 'Rebuilding native modules...'",
  "cd /app/packages/api && pnpm rebuild bcrypt || echo 'Rebuild warning (may be ok)'",
  "echo 'Install complete'"
]

[phases.build]
cmds = [
  "echo 'Starting build...'",
  "cd /app && pwd && ls -la",
  "echo 'Building all packages...'",
  "cd /app && pnpm build || echo 'Root build failed'",
  "echo 'Checking if API dist exists...'",
  "ls -la /app/packages/api/ || echo 'packages/api not found'",
  "echo 'Building API package directly...'",
  "cd /app/packages/api && pnpm build",
  "echo 'Verifying build output...'",
  "ls -la /app/packages/api/dist/ || echo 'ERROR: dist folder still not found'",
  "test -f /app/packages/api/dist/index.js && echo '✅ Build successful!' || (echo '❌ Build failed!' && exit 1)"
]

[start]
cmd = "cd /app/packages/api && pwd && ls -la && if [ ! -f dist/index.js ]; then echo 'ERROR: dist/index.js not found. Building now...' && pnpm build && ls -la dist/; fi && echo 'Starting server...' && node dist/index.js"
